from django.shortcuts import render
from django.http import HttpResponse
from photo.MyMySQL import my_sql
import time

my = my_sql()

def validate_ip(request):
    try:
        ip = request.META['HTTP_X_FORWARDED_FOR']
    except:
        ip = request.META['REMOTE_ADDR']
    now = str(time.time()).split('.')[0]
    update_time = my.select('select update_time from time_limit where ip = "%s"' % ip)
    if not len(update_time):
        return False
    elif int(now) - int(update_time[0][0]) > 300:
        return False
    else:
        my.orther('update time_limit set update_time = "%s" where ip = "%s"' % (now, ip))
        return True


# Create your views here.
def hello(request):
    print(validate_ip(request))
    if not validate_ip(request):
        # my.orther('insert into time_limit(ip,update_time) values("%s","%s")'%(ip, time.time()))
        return render(request, 'login.html')

    return HttpResponse('hahahaha')

def validate(request):
    t = str(time.time()).split('.')[0]
    try:
        ip = request.META['HTTP_X_FORWARDED_FOR']
    except:
        ip = request.META['REMOTE_ADDR']
    the_answer = request.POST['answer']
    isanswer = my.select('select answer from answer where answer = "%s"'%the_answer)
    if len(isanswer):
        sql = 'INSERT INTO time_limit(ip,update_time) VALUES("%s","%s")'%(ip,t)
        if not my.orther(sql):
            sql = 'UPDATE time_limit SET update_time = "%s" WHERE ip = "%s"'%(t,ip)
            my.orther(sql)
        return render(request, 'index.html')
    return render(request, 'login.html', {'text':'口令错误!'})




